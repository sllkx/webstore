document.addEventListener('DOMContentLoaded', function() { if (window.FHLWidgetInitialized) return; window.FHLWidgetInitialized = true; let currentDisplayItems = []; let currentPage = 1; const ITEMS_PER_PAGE = 24; let isLoadingNextPage = false; let searchTimeout = null; const widgetContainer = document.getElementById('fhl-widget-container'); const widgetWrapper = document.getElementById('fhl-widget-wrapper'); const listContainer = document.getElementById('fhl-list-container'); const searchInput = document.getElementById('fhl-search-input'); const searchResultsContainer = document.getElementById('fhl-search-results'); const appSearchTrigger = document.getElementById('fhl-app-search-trigger'); const searchClose = document.getElementById('fhl-search-close'); const indicatorTrack = document.getElementById('fhl-indicator-track'); const scrollIndicator = document.getElementById('fhl-scroll-indicator'); const addToHomeBtn = document.getElementById('fhl-add-to-home-btn'); const searchAddBtn = document.getElementById('fhl-search-add-btn'); const toastElement = document.getElementById('fhl-toast-notification'); const modeToggleBtn = document.getElementById('fhl-mode-toggle'); const toggleIcon = document.getElementById('fhl-toggle-icon'); const modeInputArea = document.getElementById('fhl-mode-input-area'); const modeInput = document.getElementById('fhl-mode-input'); const modeCloseBtn = document.getElementById('fhl-mode-close'); const sentinel = document.createElement('div'); sentinel.id = 'fhl-scroll-sentinel'; const modes = [ { name: '', urlParam: 'chat=', icon: 'Communication/chat-ai-line.svg', ph: '' }, { name: '', urlParam: 'search=', icon: 'System/search-ai-line.svg', ph: '' }, { name: '', urlParam: 'image=', icon: 'Media/image-circle-ai-line.svg', ph: '' }, { name: '', urlParam: 'video=', icon: 'Media/clapperboard-ai-fill.svg', ph: '' }, { name: '', urlParam: 'video=', icon: 'Media/music-ai-fill.svg', ph: '' } ]; let currentModeIndex = 0; let isModeActive = false; const API_BASE_URL = 'https://isai.kr'; const updateAllWidgetLinks = () => { const paramString = shortcutManager.getAsParam(); if (!paramString) return; const allLinks = document.querySelectorAll('#fhl-widget-container .fhl-icon-display, #fhl-widget-container .fhl-fixed-item'); allLinks.forEach(link => { if (link.tagName === 'A') { const originalHref = link.getAttribute('href'); if (!originalHref || originalHref.startsWith('#')) return; try { let newUrl = new URL(originalHref); const [key, value] = paramString.split('='); newUrl.searchParams.set(key, value); link.href = newUrl.toString(); link.rel = 'nofollow'; } catch (e) {} } }); }; const showToast = (message) => { }; const getProcessedUrl = (fullUrl) => { try { const urlObj = new URL(fullUrl); return `${urlObj.protocol}//${urlObj.hostname}`} catch (e) { return fullUrl} }; const createIconItem = (item, type = 'default') => { if (!item || !item.url) return document.createDocumentFragment(); const link = document.createElement('a'); if (type === 'search') { const paramString = shortcutManager.getAsParam(); let finalUrl = item.url; if (paramString) { try { let newUrl = new URL(item.url); const [key, value] = paramString.split('='); newUrl.searchParams.set(key, value); finalUrl = newUrl.toString()} catch (e) { } } link.href = finalUrl; } else { link.href = item.url} link.className = 'fhl-icon-display'; link.rel = 'nofollow'; link.setAttribute('aria-label', item.name || ''); if (item.name) { const tooltip = document.createElement('span'); tooltip.className = 'fhl-item-tooltip'; const displayName = item.name.length > 4 ? item.name.substring(0, 4) + '..' : item.name; tooltip.textContent = displayName; link.appendChild(tooltip); } if (type === 'search') { link.addEventListener('mousedown', () => { fetch(`${API_BASE_URL}/update_view_count.php`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url: item.url }) }).catch(console.error)}); link.target = '_blank'} const iconCircle = document.createElement('div'); iconCircle.className = 'fhl-icon-circle'; const imgLoading = type === 'search' ? 'lazy' : 'eager'; if (item.icon && item.icon.includes('svg')) { const iconImg = document.createElement('img'); iconImg.src = item.icon; iconImg.className = 'remix-icon'; iconImg.loading = imgLoading; iconCircle.appendChild(iconImg); } else if (item.icon && item.icon.startsWith('ph-')) { const iconImg = document.createElement('img'); iconImg.src = 'https://cdn.jsdelivr.net/npm/remixicon@4.9.1/icons/System/star-line.svg'; iconImg.className = 'remix-icon'; iconCircle.appendChild(iconImg); } else if (item.img) { const customImage = document.createElement('img'); customImage.src = item.img; customImage.alt = ''; customImage.loading = imgLoading; customImage.onerror = () => { customImage.style.display = 'none'}; iconCircle.appendChild(customImage)} else { const favicon = document.createElement('img'); favicon.src = `https://www.google.com/s2/favicons?sz=64&domain_url=${item.url}`; favicon.alt = ''; favicon.loading = imgLoading; favicon.onerror = () => { favicon.style.display = 'none'}; iconCircle.appendChild(favicon)} link.appendChild(iconCircle); if (type === 'local') { const controls = document.createElement('div'); controls.className = 'fhl-item-controls'; const deleteBtn = document.createElement('button'); deleteBtn.className = 'fhl-control-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); let storedItems = shortcutManager.get(); storedItems = storedItems.filter(stored => stored.url !== item.url); shortcutManager.set(storedItems); initialRender(currentDisplayItems.slice(0, 8))}); const moveBtn = document.createElement('button'); moveBtn.className = 'fhl-control-btn'; moveBtn.innerHTML = '&gt;'; moveBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); let storedItems = shortcutManager.get(); const currentIndex = storedItems.findIndex(stored => stored.url === item.url); if (currentIndex > -1) { const newIndex = (currentIndex + 1) % storedItems.length; const [movedItem] = storedItems.splice(currentIndex, 1); storedItems.splice(newIndex, 0, movedItem); shortcutManager.set(storedItems); initialRender(currentDisplayItems.slice(0, 8))} }); controls.appendChild(deleteBtn); controls.appendChild(moveBtn); link.appendChild(controls); } return link; }; const observerOptions = { root: searchResultsContainer, rootMargin: '100px', threshold: 0.1 }; const intersectionObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { if (entry.isIntersecting) { appendNextPage(); } }); }, observerOptions); const appendNextPage = () => { if (isLoadingNextPage || !currentDisplayItems.length) return; isLoadingNextPage = true; intersectionObserver.unobserve(sentinel); const fragment = document.createDocumentFragment(); const startIndex = (currentPage - 1) * ITEMS_PER_PAGE; for (let i = 0; i < ITEMS_PER_PAGE; i++) { const index = (startIndex + i) % currentDisplayItems.length; fragment.appendChild(createIconItem(currentDisplayItems[index], 'search')); } sentinel.remove(); searchResultsContainer.appendChild(fragment); searchResultsContainer.appendChild(sentinel); currentPage++; setTimeout(() => { isLoadingNextPage = false; intersectionObserver.observe(sentinel); }, 50); }; const initialRender = (topApps = []) => { listContainer.innerHTML = '<button class="fhl-icon-circle" style="border:0" id="fhl-edit-mode-btn"><img src="https://cdn.jsdelivr.net/npm/remixicon@4.9.1/icons/System/settings-5-line.svg" class="remix-icon"></button>'; const editModeBtn = document.getElementById('fhl-edit-mode-btn'); if (editModeBtn) { if (listContainer.classList.contains('edit-mode')) editModeBtn.classList.add('active'); editModeBtn.addEventListener('click', () => { listContainer.classList.toggle('edit-mode'); }); } const shortcuts = shortcutManager.get(); const uniqueTopApps = topApps.filter(app => !shortcuts.some(s => s.url === app.url)); const displayList = [...shortcuts, ...uniqueTopApps]; const fragment = document.createDocumentFragment(); displayList.forEach(item => { const isShortcut = shortcuts.some(s => s.url === item.url); const type = isShortcut && !item.icon && !item.img ? 'local' : 'default'; fragment.appendChild(createIconItem(item, type)); }); listContainer.appendChild(fragment); checkScrollability(); updateAllWidgetLinks(); }; const renderInitialResults = (items) => { searchResultsContainer.innerHTML = ''; currentPage = 1; currentDisplayItems = Array.isArray(items) ? items : []; intersectionObserver.disconnect(); appendNextPage(); }; fetch('/app_list_cache.json') .then(response => response.json()) .then(data => { renderInitialResults(data); const top15 = Array.isArray(data) ? data.slice(0, 8) : []; initialRender(top15); }) .catch(error => { console.error('Data Load Error', error); initialRender([]); }); const performSearch = async (query = '') => { try { const response = await fetch(`${API_BASE_URL}/appapi2.php?query=${encodeURIComponent(query)}`); if (!response.ok) throw new Error('API Error'); const results = await response.json(); renderInitialResults(results); } catch (error) { searchResultsContainer.innerHTML = ''; } }; const openAppSearch = () => { widgetContainer.classList.add('search-mode'); widgetWrapper.classList.add('search-mode'); searchInput.focus(); performSearch()}; const updateScrollIndicator = () => { const scrollLeft = listContainer.scrollLeft; const maxScrollLeft = listContainer.scrollWidth - listContainer.clientWidth; if (maxScrollLeft <= 0) return; const scrollFraction = scrollLeft / maxScrollLeft; const trackWidth = indicatorTrack.clientWidth; const indicatorWidth = scrollIndicator.clientWidth; const maxIndicatorLeft = trackWidth - indicatorWidth; const indicatorLeft = scrollFraction * maxIndicatorLeft; scrollIndicator.style.transform = `translateY(-50%) translateX(${indicatorLeft}px)`}; const checkScrollability = () => { const isScrollable = listContainer.scrollWidth > listContainer.clientWidth; widgetContainer.classList.toggle('scrollable', isScrollable); if (isScrollable) updateScrollIndicator()}; let isDragging = false; const handleDragMove = (e) => { if (!isDragging) return; e.preventDefault(); const trackRect = indicatorTrack.getBoundingClientRect(); const maxScrollLeft = listContainer.scrollWidth - listContainer.clientWidth; let positionRatio = (e.clientX - trackRect.left) / trackRect.width; positionRatio = Math.max(0, Math.min(1, positionRatio)); listContainer.scrollLeft = positionRatio * maxScrollLeft}; const handleDragEnd = () => { if (!isDragging) return; isDragging = false; document.removeEventListener('mousemove', handleDragMove); document.removeEventListener('mouseup', handleDragEnd)}; indicatorTrack.addEventListener('mousedown', (e) => { isDragging = true; handleDragMove(e); document.addEventListener('mousemove', handleDragMove); document.addEventListener('mouseup', handleDragEnd)}); const closeAppSearch = () => { widgetContainer.classList.remove('search-mode'); widgetWrapper.classList.remove('search-mode'); searchInput.value = ''; searchResultsContainer.innerHTML = ''}; let hideTimeout = null; widgetContainer.addEventListener('mouseenter', () => { clearTimeout(hideTimeout)}); widgetContainer.addEventListener('mouseleave', () => { hideTimeout = setTimeout(() => { widgetContainer.classList.add('hidden')}, 6000)}); document.addEventListener('click', (e) => { if (widgetContainer.contains(e.target)) return; if (widgetContainer.classList.contains('hidden')) { setTimeout(() => { widgetContainer.classList.remove('hidden'); clearTimeout(hideTimeout); hideTimeout = setTimeout(() => { widgetContainer.classList.add('hidden'); }, 6000); }, 50); } closeAppSearch(); }); listContainer.addEventListener('scroll', updateScrollIndicator); window.addEventListener('resize', checkScrollability); appSearchTrigger.addEventListener('click', openAppSearch); searchInput.addEventListener('input', function() { clearTimeout(searchTimeout); const query = this.value.toLowerCase().trim(); searchTimeout = setTimeout(() => { performSearch(query); }, 300); }); searchClose.addEventListener('click', closeAppSearch); document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && widgetWrapper.classList.contains('search-mode')) { closeAppSearch()} }); const updateModeView = () => { const mode = modes[currentModeIndex]; toggleIcon.src = `https://cdn.jsdelivr.net/npm/remixicon@4.9.1/icons/${mode.icon}`; modeInput.placeholder = mode.ph; }; const toggleMode = () => { if (!isModeActive) { isModeActive = true; widgetContainer.classList.add('mode-active'); currentModeIndex = 0; updateModeView(); modeInput.focus(); } else { currentModeIndex = (currentModeIndex + 1) % modes.length; updateModeView(); } }; const closeMode = () => { isModeActive = false; widgetContainer.classList.remove('mode-active'); toggleIcon.src = "https://cdn.jsdelivr.net/npm/remixicon@4.9.1/icons/System/search-ai-line.svg"; modeInput.value = ''; }; modeToggleBtn.addEventListener('click', toggleMode); modeCloseBtn.addEventListener('click', closeMode); modeInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { const val = modeInput.value.trim(); const mode = modes[currentModeIndex]; if (val) { window.location.href = `https://isai.kr/?${mode.urlParam}${encodeURIComponent(val)}`; } } }); const addCurrentPageToWidget = async (e) => { e.preventDefault(); const baseUrl = getProcessedUrl(window.location.href); let iconName = ''; try { const response = await fetch(`${API_BASE_URL}/get_title.php?url=${encodeURIComponent(baseUrl)}`); if (response.ok) { const data = await response.json(); if (data.title) { iconName = data.title} } } catch (error) {} const newIcon = { name: iconName, url: baseUrl }; let storedItems = shortcutManager.get(); const isAlreadyAdded = storedItems.some(item => getProcessedUrl(item.url) === getProcessedUrl(newIcon.url)); if (!isAlreadyAdded) { if (storedItems.length >= 10) { storedItems.shift()} storedItems.push(newIcon); shortcutManager.set(storedItems); try { await fetch(`${API_BASE_URL}/register_app.php`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(newIcon) })} catch (error) {} initialRender(currentDisplayItems.slice(0, 8)); if (widgetWrapper.classList.contains('search-mode')) { closeAppSearch()} } else { showToast(''); } }; const copyWidgetScript = (e) => { e.preventDefault(); const textToCopy = `<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sllkx/webstore@main/css.css"> <div id="app"></div> <script src='https://cdn.jsdelivr.net/gh/sllkx/webstore@main/html.js'><\/script> <script src='https://isai.kr/JS/short.js'><\/script> <script src='https://cdn.jsdelivr.net/gh/sllkx/webstore@main/main_asset.js'><\/script>`; const fallbackCopy = () => { const textArea = document.createElement("textarea"); textArea.value = textToCopy; textArea.style.position = "fixed"; textArea.style.top = 0; textArea.style.left = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy'); showToast('')} catch (err) {} document.body.removeChild(textArea)}; if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(textToCopy).then(() => { showToast('')}).catch(() => { fallbackCopy()})} else { fallbackCopy()} }; addToHomeBtn.addEventListener('click', addCurrentPageToWidget); searchAddBtn.addEventListener('click', copyWidgetScript); shortcutManager.syncFromURL(); shortcutManager.get(); });
